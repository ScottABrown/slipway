language: go

install:
  - go get github.com/constabulary/gb/...

branches:
  only:
    - master

before_script:
  - "if [ $TRAVIS_PULL_REQUEST = 'false' ]; then git checkout -qf $TRAVIS_BRANCH; fi"

script:
  - export TAR_NAME=slipway-$TARGET_PLATFORM-amd64-$CLI_VERSION.tar.gz
  - gb test -v
  - GOOS=$TARGET_PLATFORM GOARCH=amd64 CGO_ENABLED=0 gb build -ldflags "-X main.globalBuildVersion=$TRAVIS_BUILD_NUMBER"
  - mv bin/slipway-$TARGET_PLATFORM-amd64 ./slipway
  - tar -zcvf $TAR_NAME slipway
  - "if [ $TRAVIS_PULL_REQUEST = 'false' ]; then git tag $CLI_VERSION && git push --tags origin; fi"
  - "if [ $TRAVIS_PULL_REQUEST = 'false' ]; then curl -u $NEXUS_CREDENTIALS --upload-file $TAR_NAME $NEXUS_URL/$TAR_NAME; fi"
  - "if [ $TRAVIS_PULL_REQUEST = 'false' ]; then echo 'Download from ' $NEXUS_URL/$TAR_NAME; fi"

matrix:
  include:
    - go: 1.7
      env: TARGET_PLATFORM=linux
    - go: 1.7
      env: TARGET_PLATFORM=darwin

env:
  global:
    - CLI_VERSION="0.1.$TRAVIS_BUILD_NUMBER"
    - NEXUS_URL="http://nexus.oncue.verizon.net/nexus/content/repositories/releases/verizon/inf/slipway/$CLI_VERSION"
    - secure: "ABW2YjCq0xhkWbnrazL1IhKaIN7zr90BQWmeC3uII/4mQJ5sxY0sssFSMWM1hMDDzWKjpXTeVJlhjqyPQ9LHceLjA74UrPBKX8saKg0f4ZcfbjFyXSCEme6nDl4ktYuuqDFlTNdokpOtb6mHQiPLHahNkIVjL48s32WoaCEZsKg="
